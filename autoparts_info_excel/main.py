import os
import glob

import pandas as pd

def process_excel_file(path):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω Excel-—Ñ–∞–π–ª –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∞—Ä—Ç–∏–∫—É–ª—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ü–µ–Ω—É.

    –ê—Ä—Ç–∏–∫—É–ª—ã —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É, –∞ —Ü–µ–Ω–∞ –±–µ—Ä–µ—Ç—Å—è –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≥—Ä—É–ø–ø—ã
    (—Å—Ç–æ–ª–±–µ—Ü 6 = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Å—Ç–æ–ª–±–µ—Ü 7 = —Ü–µ–Ω–∞). –ü—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–µ 4 —Å—Ç—Ä–æ–∫–∏.

    :param path: –ø—É—Ç—å –∫ Excel-—Ñ–∞–π–ª—É
    :return: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∫–ª—é—á–∞–º–∏ '–ê—Ä—Ç–∏–∫—É–ª', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–¶–µ–Ω–∞'
    """
    # –ß–∏—Ç–∞–µ–º Excel –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–µ 4 —Å—Ç—Ä–æ–∫–∏
    df = pd.read_excel(path, header=None, skiprows=4)

    results_dict = {}  # —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    current_price = None  # —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≥—Ä—É–ø–ø—ã

    for i in range(len(df)):
        row = df.iloc[i]

        # ------------------------------
        # 1) –°—Ç—Ä–æ–∫–∞ –≥—Ä—É–ø–ø—ã: —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ü–µ–Ω—É
        # ------------------------------
        if pd.notna(row[5]) and pd.notna(row[6]):
            try:
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ü–µ–Ω—É –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ "6 900,00" –≤ float
                current_price = float(str(row[6]).replace(' ', '').replace(',', '.'))
            except Exception:
                current_price = None
            continue  # –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É –≥—Ä—É–ø–ø—ã

        # ------------------------------
        # 2) –°—Ç—Ä–æ–∫–∞ —Å –∞—Ä—Ç–∏–∫—É–ª–æ–º (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 'BNN')
        # ------------------------------
        if isinstance(row[2], str) and row[2].startswith('BNN'):
            article = row[2]

            # –ï—Å–ª–∏ –∞—Ä—Ç–∏–∫—É–ª –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤–ø–µ—Ä–≤—ã–µ, —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
            if article not in results_dict:
                results_dict[article] = {'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': 0, '–¶–µ–Ω–∞': current_price}

            # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ —á–∏—Å–ª—É —Å—Ç—Ä–æ–∫ —Å —ç—Ç–∏–º –∞—Ä—Ç–∏–∫—É–ª–æ–º
            results_dict[article]['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'] += 1

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ª–æ–≤–∞—Ä—å –≤ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Excel
    results = []
    for k, v in results_dict.items():
        results.append({'–ê—Ä—Ç–∏–∫—É–ª': k, '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': v['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'], '–¶–µ–Ω–∞': v['–¶–µ–Ω–∞']})

    return results


def save_result(results, source_file):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—ã–π Excel-—Ñ–∞–π–ª.

    :param results: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏
    :param source_file: –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª Excel (–¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏–º–µ–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)
    """
    os.makedirs('results', exist_ok=True)  # —Å–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É results, –µ—Å–ª–∏ –Ω–µ—Ç

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    base_name = os.path.basename(source_file).rsplit('.', 1)[0]
    out_path = f'results/{base_name}_result_data.xlsx'

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º DataFrame –≤ Excel
    df = pd.DataFrame(results)
    df.to_excel(out_path, index=False)

    print(f'‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {out_path}')


def main(folder='data'):
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ Excel-—Ñ–∞–π–ª—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ.

    :param folder: –ø–∞–ø–∫–∞, –≤ –∫–æ—Ç–æ—Ä–æ–π –∏—Å–∫–∞—Ç—å Excel-—Ñ–∞–π–ª—ã
    """
    # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ñ–∞–π–ª—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .xls –∏ .xlsx
    files = glob.glob(os.path.join(folder, '*.xls')) + \
            glob.glob(os.path.join(folder, '*.xlsx'))

    if not files:
        print('‚ùó –í –ø–∞–ø–∫–µ data/ –Ω–µ—Ç Excel-—Ñ–∞–π–ª–æ–≤ (.xls –∏–ª–∏ .xlsx)')
        return

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –ø–æ –æ—á–µ—Ä–µ–¥–∏
    for file in files:
        print(f'üìÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é: {file}')
        results = process_excel_file(file)
        save_result(results, file)


if __name__ == '__main__':
    main()
